<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>BrokerHub | God Only Knows</title><meta name="keywords" content="BrokerHub"><meta name="author" content="agsd"><meta name="copyright" content="agsd"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#1C1A22"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="BrokerHub"><meta name="application-name" content="BrokerHub"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#1C1A22"><meta property="og:type" content="article"><meta property="og:title" content="BrokerHub"><meta property="og:url" content="http://example.com/2026/01/29/BrokerHub/index.html"><meta property="og:site_name" content="God Only Knows"><meta property="og:description" content="0. BrokerHub 可以用来干什么？ BrokerHub一个由中山大学 HuangLab 开发的区块链协议验证平台，名为 BlockEmulator。 简单来说，它的用途是帮助研究人员或学生快速“模拟”和“验证”新的区块链技术，特别是“分片（Sharding）”和“共识协议”。它不是一个用来挖"><meta property="og:locale" content="en"><meta property="og:image" content="http://example.com/cover/cover4.jpg"><meta property="article:author" content="agsd"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/cover/cover4.jpg"><meta name="description" content="0. BrokerHub 可以用来干什么？ BrokerHub一个由中山大学 HuangLab 开发的区块链协议验证平台，名为 BlockEmulator。 简单来说，它的用途是帮助研究人员或学生快速“模拟”和“验证”新的区块链技术，特别是“分片（Sharding）”和“共识协议”。它不是一个用来挖"><link rel="shortcut icon" href="/icons/bank.png"><link rel="canonical" href="http://example.com/2026/01/29/BrokerHub/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"tianli","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"(つ´∀｀)つ再见~","backTitle":"♪(^∇^*)欢迎回来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo.agsd.top/',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":5},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"api","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤖️ 算法绝缘体","🔍 三分钟热度","🤝 乐观主义者","💢 最讨厌废话"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"Author: agsd","link":"Link: ","source":"Source: God Only Knows","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.","copySuccess":"Copy success, copy and reprint please mark the address of this article"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'God Only Knows',
  title: 'BrokerHub',
  postAI: '',
  pageFillDescription: '0. BrokerHub 可以用来干什么？, 0.1它可以帮你做这些事：, 1. 核心参数说明, 1.1关键参数配置, 1.2如何修改参数, 2. 如何运行BrokerHub, 2.1编译, 2.2运行, 3. BrokerHub 项目实验无法自动终止问题的排查与修复, 3.1问题描述, 3.2系统停止机制分析, 3.3逐步排查过程, 3.3.1 排查一：supervisor.go 中的调试代码, 3.3.2 排查二：MsgSendingControl() 死循环（根因）, 3.4验证, 3.5结论, 4. 极端参数压力测试学习法, 4.1StopSignal 停止机制, 4.2区块的完整生命周期, 4.3Broker 机制产生的交易放大效应, 4.4极端参数如何破坏停止条件, 4.4.1 出块速率远超交易消化速率, 4.4.2 Broker 衍生交易形成持续注入流, 4.4.3 三分片交替出块的竞态效应, 4.5合理参数为何能正常停止, 4.6结论, 4.7合理参数为何能正常停止, 4.8结论可以用来干什么一个由中山大学开发的区块链协议验证平台名为简单来说它的用途是帮助研究人员或学生快速模拟和验证新的区块链技术特别是分片和共识协议它不是一个用来挖矿赚钱的工具而是一个科研实验工具它可以帮你做这些事模拟区块链运行它可以在一台电脑或多台上模拟出一整条分片区块链网络包含多个分片多个节点验证跨分片机制它内置了两种主流的跨分片技术的机制和的机制你可以用它来测试不同分片间怎么处理交易验证共识算法它支持拜占庭容错等共识协议你可以修改代码来测试自己写的新共识算法效果如何跑实验出数据它会自动记录吞吐量延迟等核心指标并输出成文件写论文或做研究时可以直接用这些数据画图支持智能合约它包含了一个模块可以在模拟链上跑智能合约总结如果你在做区块链底层技术的研究比如想改进分片效率设计新共识这个项目就是你的测试沙盒让你不必从零写一条区块链就能验证你的想法核心参数说明项目的核心参数集中在文件中关键参数配置参数名默认值含义作用更新建议出块间隔每隔多少毫秒产生一个新区块想让出块更快就改小模拟高延迟环境可改大区块最大容量一个区块里最多能装多少笔交易限制吞吐量上限的参数之一交易注入速度模拟器每秒向网络发送多少笔交易最重要的负载参数想测极限性能就把这个调大看系统能不能撑住总交易数量整个实验一共跑多少笔交易后停止控制实验时长如果跑太久可以改小这个值批处理大小每次读取并发送多少笔交易最好比稍微大一点保证发送顺畅分片数量整个网络被切分成几个片验证分片扩展性的核心参数分片内节点数每个分片里有多少个节点参与共识节点越多共识通常越慢数量辅助跨分片的中间人节点数量仅在模式下生效数据输出路径实验结果存哪儿一般不用改如何修改参数打开配置文件编辑文件找到对应的变量值直接修改数字修改代码后需要重新编译如何运行在上大致分两步编译运行脚本编译运行直接执行启动脚本会自动启动个分片每分片个节点并写入配置执行过程如下项目实验无法自动终止问题的排查与修复问题描述在运行实验平台时执行启动脚本后实验进程无法自动终止日志中计数持续递增已超过目录始终未生成系统停止机制分析通过阅读源码梳理出系统的正常关闭流程如下中的执行顺序为返回轮询等待连续收到个空区块上报向所有节点发送消息调用将测量数据写入下的文件其中机制见要求连续收到个空区块消息后才判定实验结束任何非空区块都会将计数器重置为逐步排查过程排查一中的调试代码在发现无限循环程序在这里无限等待即进入死循环每秒一次如果不注释掉注释在这里会一直卡住不会继续往下执行不会发送信号也不会关闭和写入结果文件排查二死循环根因启动脚本使用对应实际加载的实现为中的对比能正常终止的后者从文件读取交易达到后退出而的实现包含两个无退出条件的死循环死循环无限生成随机交易死循环无限处理用户请求队列处理队列由于永远不返回中后续的停止逻辑永远无法执行值得注意的是代码中已定义了字段且在其他方法中存在对该字段的判断第行但中未引用此退出条件修复措施在中引入退出机制核心改动如下原有交易生成逻辑不变处理剩余队列后退出原有队列处理逻辑不变通过信号在两个循环间协调退出确保达到上限后正常返回验证修复后重新编译运行程序在约个约分钟后自动终止目录正常生成包含测量指标与余额收益数据结论本次问题的直接原因是缺少退出条件属于功能性缺陷排查过程中虽也发现了调试代码残留的问题并予以修正修复思路是复用已有的字段以最小改动实现循环退出保持与原有架构的一致性极端参数压力测试学习法对中参数进行极端取值来观察系统行为便于理解复杂系统终端输出循环不停停止机制中的维护一个计数器判定逻辑如下每当收到一个且空块每当收到一个非空块归零当值为时判定实验结束这意味着必须连续收到个来自各分片的空区块上报中间不能被任何一个非空区块打断区块的完整生命周期要理解何时能被满足需要追踪从交易注入到区块上报的完整链路每秒生成一批随机交易拆分交易同片交易直接发送到对应分片跨片交易拆分为见下文按批量注入各分片各分片节点循环每隔毫秒触发一次从交易池取出最多笔交易打包三阶段共识区块上链构造发送给机制产生的交易放大效应当的处理一笔跨分片交易时会产生交易乘法效应原始跨片交易发到发到余额调整交易可能发到多个分片一笔原始交易至少衍生出笔链上交易而这些衍生交易的确认又会在回调中进一步触发和形成交易注入上链回调确认再注入的闭环极端参数如何破坏停止条件当前参数为分析其所导致的时序关系出块速率远超交易消化速率每个分片每毫秒尝试出一个块个分片系统每毫秒最多产生个区块每个区块最多容纳笔交易但实际硬编码为注意虽然但第行中的参数被硬编码为因此这个参数实际上不起作用每次出块时会把交易池中的所有交易一次性打包衍生交易形成持续注入流每个每秒生成一批随机交易其中跨片交易经拆分后产生注入到不同分片这些交易上链后在中收到区块上报触发回调回调中又会通过向分片注入新的交易的确认触发等时序如下注入原始交易衍生注入各分片出块打包上报非空块归零出块打包上报非空块归零出块可能为空回调生成确认交易注入出块打包确认交易上报非空块归零注入新一批交易整个过程重复关键问题由于出块间隔仅系统在间隙期间并非空闲之前的衍生交易的确认回调会不断产生新交易这些交易以极高频率一个块被打包上报个分片交替上报非空块使得计数器在到达之前就被频繁重置三分片交替出块的竞态效应个分片独立出块各自的出块时机不同步即使某个分片的交易池已空其他分片可能仍有衍生交易在处理时间线空空非空空空空空非空空空非空空确认交易到达非空空空非空空空到达永远无法累积到三个分片的非空块在时间轴上交错出现使得连续空块窗口始终无法维持到个合理参数为何能正常停止当秒时每个分片每秒只出一个块给系统充足时间消化所有衍生交易一个的所有交易原始衍生确认在几个块内就能全部处理完间隙秒内足够出轮空块个分片各出个空块个空块上报能够顺利累积到阈值触发正常关闭结论的设计前提是交易注入有限出块间隔合理衍生交易能在若干轮出块内被完全消化极端参数出块打破了这一前提的交易放大效应确认回调的循环注入多分片交替出块使得系统中始终存在零星的非空块计数器永远无法连续累积到阈值三个分片的非空块在时间轴上交错出现使得连续空块窗口始终无法维持到个合理参数为何能正常停止当秒时每个分片每秒只出一个块给系统充足时间消化所有衍生交易一个的所有交易原始衍生确认在几个块内就能全部处理完间隙秒内足够出轮空块个分片各出个空块个空块上报能够顺利累积到阈值触发正常关闭结论的设计前提是交易注入有限出块间隔合理衍生交易能在若干轮出块内被完全消化极端参数出块打破了这一前提的交易放大效应确认回调的循环注入多分片交替出块使得系统中始终存在零星的非空块计数器永远无法连续累积到阈值',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2026-02-06 00:00:00',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#1C1A22')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#F3EEFA')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/home.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"><meta name="generator" content="Hexo 8.1.1"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div id="loading-box-me"><div id="wrapper"><div id="mouse"></div><div class="loader"></div><div class="loading-bar-me"><div class="progress-bar"></div></div><div class="status"><div class="state"></div><div class="percentage"></div></div></div></div></div><script>const preloader = {
  endLoading: () => {
    var loadingBox = document.getElementById('loading-box');
    var loadingBoxme = document.getElementById('loading-box-me');
    loadingBoxme.addEventListener('animationend', () => {setTimeout(function() {loadingBox.classList.add("loaded");}, 2000) })
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  },
  otherendLoading: () => {
    document.getElementById('loading-box').classList.add("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.otherendLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.otherendLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/agsd-agsd" title="Github"><img class="back-menu-item-icon" src="/icons/GitHub_Logo.png" alt="Github"/><span class="back-menu-item-text">Github</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">快乐老家</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.pixiv.net/" title="Pixiv"><img class="back-menu-item-icon" src="/icons/pixiv.png" alt="Pixiv"/><span class="back-menu-item-text">Pixiv</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">God Only Knows</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> Album</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> MyInfo</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> Stroll</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="Random Post" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="Search 🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> Search</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="Console" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">Interests</div><span class="author-content-item-title">Find your area of interest</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BrokerHub/" style="font-size: 1.05rem;">BrokerHub<sup>1</sup></a><a href="/tags/Tools/" style="font-size: 1.05rem;">Tools<sup>2</sup></a><a href="/tags/hexo/" style="font-size: 1.05rem;">hexo<sup>5</sup></a><a href="/tags/website/" style="font-size: 1.05rem;">website<sup>3</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>Articles</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>Archives</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/02/"><span class="card-archive-list-date">February 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/01/"><span class="card-archive-list-date">January 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="Toggle Display Mode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="Toggle Sidebar"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="Toggle Music"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="Toggle"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Lab/" itemprop="url">Lab</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/BrokerHub/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>BrokerHub</span></a></span></div></div><h1 class="post-title" itemprop="name headline">BrokerHub</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2026-01-29T07:19:27.356Z" title="Created 2026-01-29 15:19:27">2026-01-29</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2026-02-05T16:00:00.000Z" title="Updated 2026-02-06 00:00:00">2026-02-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">Word count:</span><span class="word-count" title="文章字数">3.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">Reading time:</span><span>11min</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为新艾利都"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>新艾利都</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/cover/cover4.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2026/01/29/BrokerHub/"><header><a class="post-meta-categories" href="/categories/Lab/" itemprop="url">Lab</a><a href="/tags/BrokerHub/" tabindex="-1" itemprop="url">BrokerHub</a><h1 id="CrawlerTitle" itemprop="name headline">BrokerHub</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">agsd</span><time itemprop="dateCreated datePublished" datetime="2026-01-29T07:19:27.356Z" title="Created 2026-01-29 15:19:27">2026-01-29</time><time itemprop="dateCreated datePublished" datetime="2026-02-05T16:00:00.000Z" title="Updated 2026-02-06 00:00:00">2026-02-06</time></header><h1 id="0-BrokerHub-可以用来干什么？"><a href="#0-BrokerHub-可以用来干什么？" class="headerlink" title="0. BrokerHub 可以用来干什么？"></a>0. BrokerHub 可以用来干什么？</h1><hr>
<p><a target="_blank" rel="noopener" href="https://github.com/math-zhuxy/BrokerHub">BrokerHub</a>一个由<strong>中山大学 HuangLab</strong> 开发的区块链协议验证平台，名为 <strong>BlockEmulator</strong>。</p>
<p>简单来说，<strong>它的用途是帮助研究人员或学生快速“模拟”和“验证”新的区块链技术</strong>，特别是“分片（Sharding）”和“共识协议”。它不是一个用来挖矿赚钱的工具，而是一个<strong>科研实验工具</strong>。</p>
<h2 id="0-1它可以帮你做这些事："><a href="#0-1它可以帮你做这些事：" class="headerlink" title="0.1它可以帮你做这些事："></a>0.1它可以帮你做这些事：</h2><ol>
<li><strong>模拟区块链运行</strong>：<br> 它可以在一台电脑（或多台）上模拟出一整条分片区块链网络，包含多个分片、多个节点。</li>
<li><strong>验证“跨分片”机制</strong>：<br> 它内置了两种主流的跨分片技术（BrokerChain 的 Broker 机制和 Monoxide 的 Relay 机制），你可以用它来测试不同分片间怎么处理交易。</li>
<li><strong>验证“共识”算法</strong>：<br> 它支持 PBFT（拜占庭容错）等共识协议，你可以修改代码来测试自己写的新共识算法效果如何。</li>
<li><strong>跑实验、出数据</strong>：<br> 它会自动记录 TPS（吞吐量）、延迟等核心指标，并输出成 CSV 文件。写论文或做研究时，可以直接用这些数据画图。</li>
<li><strong>支持智能合约</strong>：<br> 它包含了一个 VM 模块，可以在模拟链上跑 Solidity 智能合约。</li>
</ol>
<p><strong>总结</strong>：如果你在做区块链底层技术的研究（比如想改进分片效率、设计新共识），这个项目就是你的“测试沙盒”，让你不必从零写一条区块链就能验证你的想法。</p>
<h1 id="1-核心参数说明"><a href="#1-核心参数说明" class="headerlink" title="1. 核心参数说明"></a>1. 核心参数说明</h1><hr>
<p>项目的核心参数集中在 <code>BrokerHub/params/global_config.go</code> 文件中。</p>
<h2 id="1-1关键参数配置"><a href="#1-1关键参数配置" class="headerlink" title="1.1关键参数配置"></a>1.1关键参数配置</h2><table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">默认值</th>
<th align="left">含义&#x2F;作用</th>
<th align="left">更新建议</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Block_Interval</strong></td>
<td align="left"><code>1000</code></td>
<td align="left"><strong>出块间隔 (ms)</strong><br>每隔多少毫秒产生一个新区块</td>
<td align="left">想让出块更快就改小，模拟高延迟环境可改大</td>
</tr>
<tr>
<td align="left"><strong>MaxBlockSize_global</strong></td>
<td align="left"><code>500000</code></td>
<td align="left"><strong>区块最大容量</strong><br>一个区块里最多能装多少笔交易</td>
<td align="left">限制吞吐量上限的参数之一</td>
</tr>
<tr>
<td align="left"><strong>InjectSpeed</strong></td>
<td align="left"><code>5000</code></td>
<td align="left"><strong>交易注入速度 (TPS)</strong><br>模拟器每秒向网络发送多少笔交易</td>
<td align="left"><strong>最重要的负载参数</strong><br>想测极限性能就把这个调大，看系统能不能撑住</td>
</tr>
<tr>
<td align="left"><strong>TotalDataSize</strong></td>
<td align="left"><code>500000</code></td>
<td align="left"><strong>总交易数量</strong><br>整个实验一共跑多少笔交易后停止</td>
<td align="left">控制实验时长。如果跑太久，可以改小这个值</td>
</tr>
<tr>
<td align="left"><strong>BatchSize</strong></td>
<td align="left"><code>5000</code></td>
<td align="left"><strong>批处理大小</strong><br>Supervisor 每次读取并发送多少笔交易</td>
<td align="left">最好比 <strong>InjectSpeed</strong> 稍微大一点，保证发送顺畅</td>
</tr>
<tr>
<td align="left"><strong>ShardNum</strong></td>
<td align="left"><code>4</code></td>
<td align="left"><strong>分片数量</strong><br>整个网络被切分成几个片</td>
<td align="left">验证分片扩展性的核心参数</td>
</tr>
<tr>
<td align="left"><strong>NodesInShard</strong></td>
<td align="left"><code>4</code></td>
<td align="left"><strong>分片内节点数</strong><br>每个分片里有多少个节点参与共识</td>
<td align="left">节点越多，共识（PBFT）通常越慢</td>
</tr>
<tr>
<td align="left"><strong>BrokerNum</strong></td>
<td align="left"><code>1</code></td>
<td align="left"><strong>Broker 数量</strong><br>辅助跨分片的中间人节点数量</td>
<td align="left">仅在 broker 模式下生效</td>
</tr>
<tr>
<td align="left"><strong>DatWrite_path</strong></td>
<td align="left"><code>&quot;./result/&quot;</code></td>
<td align="left"><strong>数据输出路径</strong><br>实验结果 CSV 存哪儿</td>
<td align="left">一般不用改</td>
</tr>
</tbody></table>
<h2 id="1-2如何修改参数"><a href="#1-2如何修改参数" class="headerlink" title="1.2如何修改参数"></a>1.2如何修改参数</h2><ol>
<li><strong>打开配置文件</strong><ul>
<li>编辑 <code>global_config.go</code> 文件</li>
<li>找到对应的变量值直接修改数字</li>
</ul>
</li>
</ol>
<p><strong>修改代码后需要重新编译</strong></p>
<h1 id="2-如何运行BrokerHub"><a href="#2-如何运行BrokerHub" class="headerlink" title="2. 如何运行BrokerHub"></a>2. 如何运行BrokerHub</h1><hr>
<p>在 <code>Windows</code> 上大致分两步：</p>
<ol>
<li>编译</li>
<li>运行脚本</li>
</ol>
<h2 id="2-1编译"><a href="#2-1编译" class="headerlink" title="2.1编译"></a>2.1编译</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> build -o blockEmulator_Windows_Precompile.exe ./main.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2运行"><a href="#2-2运行" class="headerlink" title="2.2运行"></a>2.2运行</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bat_shardNum=<span class="number">3</span>_NodeNum=<span class="number">4</span>_mod=Broker_b2e.bat</span><br></pre></td></tr></table></figure>
<p>直接执行 Windows 启动脚本（会自动启动 3 个分片、每分片 4 个节点并写入配置）。<br>执行过程如下。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/pics/2026-2/vscodebrokerhub.png"></p>
<h1 id="3-BrokerHub-项目实验无法自动终止问题的排查与修复"><a href="#3-BrokerHub-项目实验无法自动终止问题的排查与修复" class="headerlink" title="3. BrokerHub 项目实验无法自动终止问题的排查与修复"></a>3. BrokerHub 项目实验无法自动终止问题的排查与修复</h1><h3 id="3-1问题描述"><a href="#3-1问题描述" class="headerlink" title="3.1问题描述"></a>3.1问题描述</h3><p>在运行 BrokerHub（BVM + Brokerchain 实验平台）时，执行启动脚本 bat_shardNum&#x3D;3_NodeNum&#x3D;4_mod&#x3D;Broker_b2e.bat 后，实验进程无法自动终止，Supervisor 日志中 epoch 计数持续递增（已超过 500），result 目录始终未生成。</p>
<h3 id="3-2系统停止机制分析"><a href="#3-2系统停止机制分析" class="headerlink" title="3.2系统停止机制分析"></a>3.2系统停止机制分析</h3><p>通过阅读源码，梳理出系统的正常关闭流程如下：</p>
<p>supervisor.go 中 <code>SupervisorTxHandling()</code> 的执行顺序为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MsgSendingControl() 返回</span><br><span class="line">    → 轮询 StopSignal.GapEnough()（等待连续收到 2×ShardNum 个空区块上报）</span><br><span class="line">        → 向所有节点发送 CStop 消息</span><br><span class="line">            → 调用 CloseSupervisor()，将测量数据写入 ./result/ 下的 CSV 文件</span><br></pre></td></tr></table></figure>

<p>其中 <code>StopSignal</code> 机制（见 supervisorStopModule.go）要求连续收到 <code>stopThreshold</code> 个空区块消息后才判定实验结束。任何非空区块都会将计数器重置为 0。</p>
<h2 id="3-3逐步排查过程"><a href="#3-3逐步排查过程" class="headerlink" title="3.3逐步排查过程"></a>3.3逐步排查过程</h2><h3 id="3-3-1-排查一：supervisor-go-中的调试代码"><a href="#3-3-1-排查一：supervisor-go-中的调试代码" class="headerlink" title="3.3.1 排查一：supervisor.go 中的调试代码"></a>3.3.1 排查一：supervisor.go 中的调试代码</h3><p>在 supervisor.go 发现无限循环：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add</span><br><span class="line"><span class="keyword">for</span> <span class="literal">true</span> &#123;</span><br><span class="line">	time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序在这里<strong>无限等待</strong>，即进入死循环，每秒 sleep 一次。<br>如果不注释掉注释，Supervisor 在这里会一直卡住，不会继续往下执行（不会发送 stop 信号，也不会关闭和写入结果文件）。</p>
<h3 id="3-3-2-排查二：MsgSendingControl-死循环（根因）"><a href="#3-3-2-排查二：MsgSendingControl-死循环（根因）" class="headerlink" title="3.3.2 排查二：MsgSendingControl() 死循环（根因）"></a>3.3.2 排查二：MsgSendingControl() 死循环（根因）</h3><p>启动脚本使用 <code>-m 4</code>，对应 <code>CommitteeMethod[4] = &quot;Broker_b2e&quot;</code>，实际加载的实现为 committee_brokerhub.go 中的 <code>BrokerhubCommitteeMod.MsgSendingControl()</code>。</p>
<p>对比能正常终止的 <code>BrokerCommitteeMod.MsgSendingControl()</code>（<code>-m 2</code>），后者从 CSV 文件读取交易，达到 <code>TotalDataSize</code> 后 <code>break</code> 退出。而 <code>BrokerhubCommitteeMod</code> 的实现包含<strong>两个无退出条件的死循环</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 死循环 1：无限生成随机交易</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        bcm.hubParams.currentEpoch++</span><br><span class="line">        txs := bcm.generateRandomTxs()</span><br><span class="line">        bcm.txSending(...)</span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 死循环 2：无限处理用户请求队列</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    time.Sleep(time.Millisecond * <span class="number">100</span>)</span><br><span class="line">    <span class="comment">// ...处理队列...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于 <code>MsgSendingControl()</code> 永远不返回，<code>SupervisorTxHandling()</code> 中后续的停止逻辑永远无法执行。值得注意的是，代码中已定义了 <code>simulation_param.endedEpoch = 86</code> 字段，且在其他方法中存在对该字段的判断（第 473、806 行），但 <code>MsgSendingControl()</code> 中<strong>未引用</strong>此退出条件。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/pics/2026-2/varEndedEpoch.png"></p>
<p><strong>修复措施</strong>：在 <code>MsgSendingControl()</code> 中引入 <code>endedEpoch</code> 退出机制。核心改动如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        bcm.hubParams.currentEpoch++</span><br><span class="line">        <span class="keyword">if</span> bcm.hubParams.currentEpoch &gt; bcm.hubParams.endedEpoch &#123;</span><br><span class="line">            <span class="built_in">close</span>(done)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...原有交易生成逻辑不变...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-done:</span><br><span class="line">        <span class="comment">// 处理剩余队列后退出</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...原有队列处理逻辑不变...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 channel 信号在两个循环间协调退出，确保 epoch 达到上限后 <code>MsgSendingControl()</code> 正常返回。</p>
<h2 id="3-4验证"><a href="#3-4验证" class="headerlink" title="3.4验证"></a>3.4验证</h2><p>修复后重新编译运行，程序在约 86 个 epoch（约 3 分钟）后自动终止，result 目录正常生成，包含 Supervisor 测量指标 CSV 与 Broker 余额&#x2F;收益数据。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/pics/2026-2/brokerhubresult.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/pics/2026-2/BrokerHubResultExcel.png"></p>
<h2 id="3-5结论"><a href="#3-5结论" class="headerlink" title="3.5结论"></a>3.5结论</h2><p>本次问题的直接原因是 <code>BrokerhubCommitteeMod.MsgSendingControl()</code> 缺少退出条件，属于功能性缺陷。排查过程中虽也发现了<strong>调试代码残留</strong>的问题并予以修正。修复思路是复用已有的 <code>endedEpoch</code> 字段，以最小改动实现循环退出，保持与原有架构的一致性。</p>
<h1 id="4-极端参数压力测试学习法"><a href="#4-极端参数压力测试学习法" class="headerlink" title="4. 极端参数压力测试学习法"></a>4. 极端参数压力测试学习法</h1><hr>
<p>对<code>global_config.go</code>中参数进行极端取值。来观察系统行为，便于理解复杂系统。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> params</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line"></span><br><span class="line">    Block_Interval      = <span class="number">1</span> <span class="comment">// generate new block interval (ms)</span></span><br><span class="line"></span><br><span class="line">    MaxBlockSize_global = <span class="number">1</span> <span class="comment">// the block contains the maximum number of transactions</span></span><br><span class="line"></span><br><span class="line">    InjectSpeed         = <span class="number">1</span> <span class="comment">// the transaction inject speed</span></span><br><span class="line"></span><br><span class="line">    TotalDataSize       = <span class="number">1</span> <span class="comment">// the total number of txs</span></span><br><span class="line"></span><br><span class="line">    BatchSize           = <span class="number">1</span> <span class="comment">// supervisor read a batch of txs then send them, it should be larger than inject speed</span></span><br><span class="line"></span><br><span class="line">    BrokerNum           = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    NodesInShard        = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    ShardNum            = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    IterNum_B2E         = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    Brokerage           = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    DataWrite_path      = <span class="string">&quot;./result/&quot;</span> <span class="comment">// measurement data result output path</span></span><br><span class="line"></span><br><span class="line">    LogWrite_path       = <span class="string">&quot;./log&quot;</span>     <span class="comment">// log output path</span></span><br><span class="line"></span><br><span class="line">    KeyWrite_path       = <span class="string">&quot;./key&quot;</span></span><br><span class="line"></span><br><span class="line">    SupervisorAddr      = <span class="string">&quot;127.0.0.1:18800&quot;</span> <span class="comment">//supervisor ip address</span></span><br><span class="line"></span><br><span class="line">    FileInput           = <span class="string">&quot;./TXs.csv&quot;</span>       <span class="comment">//the raw BlockTransaction data path</span></span><br><span class="line"></span><br><span class="line">    NodeID              <span class="type">uint64</span></span><br><span class="line"></span><br><span class="line">    ShardID             <span class="type">uint64</span></span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/pics/2026-2/BrokerHubCycling.png"><br>终端输出循环不停。</p>
<h2 id="4-1StopSignal-停止机制"><a href="#4-1StopSignal-停止机制" class="headerlink" title="4.1StopSignal 停止机制"></a>4.1StopSignal 停止机制</h2><p>supervisorStopModule.go 中的 <code>StopSignal</code> 维护一个计数器 <code>stopGap</code>，判定逻辑如下：</p>
<ul>
<li>每当 Supervisor 收到一个 <code>BlockInfoMsg</code> 且 <code>BlockBodyLength == 0</code>（空块），<code>stopGap++</code></li>
<li>每当收到一个 <code>BlockBodyLength &gt; 0</code>（非空块），<code>stopGap</code> <strong>归零</strong></li>
<li>当 <code>stopGap &gt;= stopThreshold</code>（值为 <code>2 × ShardNum = 6</code>）时，判定实验结束</li>
</ul>
<p>这意味着：<strong>必须连续收到 6 个来自各分片的空区块上报，中间不能被任何一个非空区块打断</strong>。</p>
<h3 id="4-2区块的完整生命周期"><a href="#4-2区块的完整生命周期" class="headerlink" title="4.2区块的完整生命周期"></a>4.2区块的完整生命周期</h3><p>要理解 StopSignal 何时能被满足，需要追踪从交易注入到区块上报的完整链路：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Supervisor (MsgSendingControl)</span><br><span class="line">  ├── 每 2 秒生成一批随机交易</span><br><span class="line">  ├── dealTxByBroker() 拆分交易</span><br><span class="line">  │     ├── 同片交易 → 直接发送到对应分片</span><br><span class="line">  │     └── 跨片交易 → Broker 拆分为 Tx1 + Tx2（见下文）</span><br><span class="line">  └── txSending() → 按 InjectSpeed 批量注入各分片</span><br><span class="line">  </span><br><span class="line">各分片 PBFT 节点 (Propose 循环)</span><br><span class="line">  ├── 每隔 Block_Interval 毫秒触发一次</span><br><span class="line">  ├── GenerateBlock()</span><br><span class="line">  │     └── Txpool.PackTxs(50000) → 从交易池取出最多 50000 笔交易打包</span><br><span class="line">  ├── PBFT 三阶段共识（PrePrepare → Prepare → Commit）</span><br><span class="line">  └── HandleinCommit() → 区块上链 → 构造 BlockInfoMsg 发送给 Supervisor</span><br><span class="line">        └── BlockBodyLength = len(block.Body)</span><br></pre></td></tr></table></figure>

<h3 id="4-3Broker-机制产生的交易放大效应"><a href="#4-3Broker-机制产生的交易放大效应" class="headerlink" title="4.3Broker 机制产生的交易放大效应"></a>4.3Broker 机制产生的交易放大效应</h3><p>当 Supervisor 的 <code>dealTxByBroker()</code> 处理一笔跨分片交易时，会产生<strong>交易乘法效应</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原始跨片交易 (Sender@Shard0 → Recipient@Shard1)</span><br><span class="line">     │</span><br><span class="line">     ├── Tx1: Sender → Broker（发到 Shard0）</span><br><span class="line">     ├── Tx2: Broker → Recipient（发到 Shard1）</span><br><span class="line">     └── AllocatedTx: Broker 余额调整交易（可能发到多个分片）</span><br></pre></td></tr></table></figure>

<p><strong>一笔原始交易至少衍生出 2-3 笔链上交易</strong>，而这些衍生交易的确认（<code>createConfirm</code>）又会在 <code>HandleBlockInfo</code> 回调中进一步触发 <code>handleBrokerType1Mes</code> → <code>txSending(tx1s)</code> 和 <code>handleBrokerType2Mes</code> → <code>txSending(tx2s)</code>，形成<strong>交易注入 → 上链 → 回调确认 → 再注入</strong>的闭环。</p>
<h3 id="4-4极端参数如何破坏停止条件"><a href="#4-4极端参数如何破坏停止条件" class="headerlink" title="4.4极端参数如何破坏停止条件"></a>4.4极端参数如何破坏停止条件</h3><p>当前参数为 <code>Block_Interval = 1</code>，<code>MaxBlockSize_global = 1</code>，<code>InjectSpeed = 1</code>。分析其所导致的时序关系：</p>
<h4 id="4-4-1-出块速率远超交易消化速率"><a href="#4-4-1-出块速率远超交易消化速率" class="headerlink" title="4.4.1 出块速率远超交易消化速率"></a>4.4.1 出块速率远超交易消化速率</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Block_Interval = 1ms → 每个分片每毫秒尝试出一个块</span><br><span class="line">3 个分片 → 系统每毫秒最多产生 3 个区块</span><br><span class="line">每个区块最多容纳 1 笔交易（MaxBlockSize_global = 1，但实际 PackTxs 硬编码为 50000）</span><br></pre></td></tr></table></figure>

<p>注意：虽然 <code>MaxBlockSize_global = 1</code>，但 <a href="chain/blockchain.go#L1129">blockchain.go 第 1129 行</a> 中 <code>PackTxs</code> 的参数被<strong>硬编码为 50000</strong>，因此 <code>MaxBlockSize_global</code> 这个参数实际上不起作用。每次出块时会把交易池中的所有交易一次性打包。</p>
<h4 id="4-4-2-Broker-衍生交易形成持续注入流"><a href="#4-4-2-Broker-衍生交易形成持续注入流" class="headerlink" title="4.4.2 Broker 衍生交易形成持续注入流"></a>4.4.2 Broker 衍生交易形成持续注入流</h4><p>每个 epoch（每 2 秒），Supervisor 生成一批随机交易。其中跨片交易经 Broker 拆分后，产生 Tx1、Tx2、AllocatedTx 注入到不同分片。这些交易上链后，Supervisor 在 <code>HandleBlockInfo</code> 中收到区块上报，触发 <code>createConfirm</code> 回调，回调中又会通过 <code>txSending</code> 向分片注入新的交易（Tx2 的确认触发等）。</p>
<p>时序如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">t=0s    ：epoch 1 注入原始交易 → 衍生 Tx1、Tx2 注入各分片</span><br><span class="line">t=1ms   ：Shard0 出块，打包 Tx1 → 上报非空块 → stopGap 归零</span><br><span class="line">t=2ms   ：Shard1 出块，打包 Tx2 → 上报非空块 → stopGap 归零</span><br><span class="line">t=3ms   ：Shard0 出块，可能为空 → stopGap = 1</span><br><span class="line">t=4ms   ：Supervisor HandleBlockInfo 回调，生成确认交易 → 注入 Shard1</span><br><span class="line">t=5ms   ：Shard1 出块，打包确认交易 → 上报非空块 → stopGap 归零！</span><br><span class="line">t=2000ms：epoch 2 注入新一批交易 → 整个过程重复</span><br></pre></td></tr></table></figure>

<p><strong>关键问题</strong>：由于出块间隔仅 1ms，系统在 epoch 间隙期间并非空闲——之前 epoch 的衍生交易的确认回调会不断产生新交易，这些交易以极高频率（1ms 一个块）被打包上报。3 个分片交替上报非空块，使得 <code>stopGap</code> 计数器在到达 6 之前就被频繁重置。</p>
<h4 id="4-4-3-三分片交替出块的竞态效应"><a href="#4-4-3-三分片交替出块的竞态效应" class="headerlink" title="4.4.3 三分片交替出块的竞态效应"></a>4.4.3 三分片交替出块的竞态效应</h4><p>3 个分片独立出块，各自的出块时机不同步。即使某个分片的交易池已空，其他分片可能仍有衍生交易在处理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">时间线：  --|------|------|------|------|------|---&gt;</span><br><span class="line">Shard0：  空   空   非空  空   空   空</span><br><span class="line">Shard1：  空   非空  空   空   非空  空    ← Broker 确认交易到达</span><br><span class="line">Shard2：  非空  空   空   非空  空   空    ← AllocatedTx 到达</span><br><span class="line">stopGap： 1    0!   0!   0!   1    0!    ← 永远无法累积到 6</span><br></pre></td></tr></table></figure>

<p>三个分片的非空块在时间轴上<strong>交错出现</strong>，使得连续空块窗口始终无法维持到 6 个。</p>
<h2 id="4-5合理参数为何能正常停止"><a href="#4-5合理参数为何能正常停止" class="headerlink" title="4.5合理参数为何能正常停止"></a>4.5合理参数为何能正常停止</h2><p>当 <code>Block_Interval = 1000</code>（1 秒）时：</p>
<ul>
<li>每个分片每秒只出一个块，给系统充足时间消化所有衍生交易</li>
<li>一个 epoch 的所有交易（原始 + 衍生 + 确认）在几个块内就能全部处理完</li>
<li>epoch 间隙（2 秒）内足够出 2 轮空块，3 个分片各出 2 个空块 &#x3D; 6 个空块上报</li>
<li><code>stopGap</code> 能够顺利累积到阈值 6，触发正常关闭</li>
</ul>
<h2 id="4-6结论"><a href="#4-6结论" class="headerlink" title="4.6结论"></a>4.6结论</h2><p>StopSignal 的设计前提是：<strong>交易注入有限、出块间隔合理、衍生交易能在若干轮出块内被完全消化</strong>。极端参数（1ms 出块）打破了这一前提——Broker 的交易放大效应 + 确认回调的循环注入 + 多分片交替出块，使得系统中始终存在零星的非空块，<code>stopGap</code> 计数器永远无法连续累积到阈值。</p>
<p>三个分片的非空块在时间轴上<strong>交错出现</strong>，使得连续空块窗口始终无法维持到 6 个。</p>
<h2 id="4-7合理参数为何能正常停止"><a href="#4-7合理参数为何能正常停止" class="headerlink" title="4.7合理参数为何能正常停止"></a>4.7合理参数为何能正常停止</h2><p>当 <code>Block_Interval = 1000</code>（1 秒）时：</p>
<ul>
<li>每个分片每秒只出一个块，给系统充足时间消化所有衍生交易</li>
<li>一个 epoch 的所有交易（原始 + 衍生 + 确认）在几个块内就能全部处理完</li>
<li>epoch 间隙（2 秒）内足够出 2 轮空块，3 个分片各出 2 个空块 &#x3D; 6 个空块上报</li>
<li><code>stopGap</code> 能够顺利累积到阈值 6，触发正常关闭</li>
</ul>
<h2 id="4-8结论"><a href="#4-8结论" class="headerlink" title="4.8结论"></a>4.8结论</h2><p>StopSignal 的设计前提是：<strong>交易注入有限、出块间隔合理、衍生交易能在若干轮出块内被完全消化</strong>。极端参数（1ms 出块）打破了这一前提——Broker 的交易放大效应 + 确认回调的循环注入 + 多分片交替出块，使得系统中始终存在零星的非空块，<code>stopGap</code> 计数器永远无法连续累积到阈值。</p>
<hr>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">agsd</div><div class="post-copyright__author_desc">仅在此处的世界</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2026/01/29/BrokerHub/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2026/01/29/BrokerHub/')">BrokerHub</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2026/01/29/BrokerHub/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=BrokerHub&amp;url=http://example.com/2026/01/29/BrokerHub/&amp;pic=/cover/cover4.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/BrokerHub/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>BrokerHub<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/cover/cover6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2026/02/02/Adobe-Express%E5%B8%AE%E5%8A%A9%E4%BD%A0%E5%88%9B%E5%BB%BA%E8%83%8C%E6%99%AF%E9%80%8F%E6%98%8E%E5%9B%BE%E7%89%87/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/cover6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Adobe Express帮助你创建背景透明图片</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> Comment</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Waline</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/icons/LoveEye.png" alt="status"/></div></div><div class="author-info__description">An undergraduate student majoring in SE at SYSU.My favorite games are Street Fighter VI and Zenless Zone Zero.Nice to meet you!</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">agsd</h1><div class="author-info__desc">仅在此处的世界</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/agsd-agsd" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="mailto:jyao4060@gmail.com" target="_blank" title="MailToMe"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(/img/chunli1.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(/img/cammy1.png) center center / 100% no-repeat"></div></div></div></div><div class="card-widget card-countdown"><div class="item-headline"><i></i><span></span></div><div class="item-content"><div class="cd-count-left">
  <span class="cd-text">距离</span>
  <span class="cd-name" id="eventName"></span>
  <span class="cd-time" id="daysUntil"></span>
  <span class="cd-date" id="eventDate"></span>
</div>
<div id="countRight" class="cd-count-right"></div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-BrokerHub-%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%9D%A5%E5%B9%B2%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">0. BrokerHub 可以用来干什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-1%E5%AE%83%E5%8F%AF%E4%BB%A5%E5%B8%AE%E4%BD%A0%E5%81%9A%E8%BF%99%E4%BA%9B%E4%BA%8B%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">0.1它可以帮你做这些事：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">2.</span> <span class="toc-text">1. 核心参数说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E5%85%B3%E9%94%AE%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">1.1关键参数配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E5%8F%82%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">1.2如何修改参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E8%BF%90%E8%A1%8CBrokerHub"><span class="toc-number">3.</span> <span class="toc-text">2. 如何运行BrokerHub</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E7%BC%96%E8%AF%91"><span class="toc-number">3.1.</span> <span class="toc-text">2.1编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2%E8%BF%90%E8%A1%8C"><span class="toc-number">3.2.</span> <span class="toc-text">2.2运行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-BrokerHub-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E9%AA%8C%E6%97%A0%E6%B3%95%E8%87%AA%E5%8A%A8%E7%BB%88%E6%AD%A2%E9%97%AE%E9%A2%98%E7%9A%84%E6%8E%92%E6%9F%A5%E4%B8%8E%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.</span> <span class="toc-text">3. BrokerHub 项目实验无法自动终止问题的排查与修复</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">4.1.</span> <span class="toc-text">3.1问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E7%B3%BB%E7%BB%9F%E5%81%9C%E6%AD%A2%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">3.2系统停止机制分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%E9%80%90%E6%AD%A5%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B"><span class="toc-number">4.3.</span> <span class="toc-text">3.3逐步排查过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E6%8E%92%E6%9F%A5%E4%B8%80%EF%BC%9Asupervisor-go-%E4%B8%AD%E7%9A%84%E8%B0%83%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">4.3.1.</span> <span class="toc-text">3.3.1 排查一：supervisor.go 中的调试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E6%8E%92%E6%9F%A5%E4%BA%8C%EF%BC%9AMsgSendingControl-%E6%AD%BB%E5%BE%AA%E7%8E%AF%EF%BC%88%E6%A0%B9%E5%9B%A0%EF%BC%89"><span class="toc-number">4.3.2.</span> <span class="toc-text">3.3.2 排查二：MsgSendingControl() 死循环（根因）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4%E9%AA%8C%E8%AF%81"><span class="toc-number">4.4.</span> <span class="toc-text">3.4验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5%E7%BB%93%E8%AE%BA"><span class="toc-number">4.5.</span> <span class="toc-text">3.5结论</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%9E%81%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E5%AD%A6%E4%B9%A0%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">4. 极端参数压力测试学习法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1StopSignal-%E5%81%9C%E6%AD%A2%E6%9C%BA%E5%88%B6"><span class="toc-number">5.1.</span> <span class="toc-text">4.1StopSignal 停止机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E5%8C%BA%E5%9D%97%E7%9A%84%E5%AE%8C%E6%95%B4%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">5.1.1.</span> <span class="toc-text">4.2区块的完整生命周期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3Broker-%E6%9C%BA%E5%88%B6%E4%BA%A7%E7%94%9F%E7%9A%84%E4%BA%A4%E6%98%93%E6%94%BE%E5%A4%A7%E6%95%88%E5%BA%94"><span class="toc-number">5.1.2.</span> <span class="toc-text">4.3Broker 机制产生的交易放大效应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4%E6%9E%81%E7%AB%AF%E5%8F%82%E6%95%B0%E5%A6%82%E4%BD%95%E7%A0%B4%E5%9D%8F%E5%81%9C%E6%AD%A2%E6%9D%A1%E4%BB%B6"><span class="toc-number">5.1.3.</span> <span class="toc-text">4.4极端参数如何破坏停止条件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-%E5%87%BA%E5%9D%97%E9%80%9F%E7%8E%87%E8%BF%9C%E8%B6%85%E4%BA%A4%E6%98%93%E6%B6%88%E5%8C%96%E9%80%9F%E7%8E%87"><span class="toc-number">5.1.3.1.</span> <span class="toc-text">4.4.1 出块速率远超交易消化速率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-Broker-%E8%A1%8D%E7%94%9F%E4%BA%A4%E6%98%93%E5%BD%A2%E6%88%90%E6%8C%81%E7%BB%AD%E6%B3%A8%E5%85%A5%E6%B5%81"><span class="toc-number">5.1.3.2.</span> <span class="toc-text">4.4.2 Broker 衍生交易形成持续注入流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-3-%E4%B8%89%E5%88%86%E7%89%87%E4%BA%A4%E6%9B%BF%E5%87%BA%E5%9D%97%E7%9A%84%E7%AB%9E%E6%80%81%E6%95%88%E5%BA%94"><span class="toc-number">5.1.3.3.</span> <span class="toc-text">4.4.3 三分片交替出块的竞态效应</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5%E5%90%88%E7%90%86%E5%8F%82%E6%95%B0%E4%B8%BA%E4%BD%95%E8%83%BD%E6%AD%A3%E5%B8%B8%E5%81%9C%E6%AD%A2"><span class="toc-number">5.2.</span> <span class="toc-text">4.5合理参数为何能正常停止</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6%E7%BB%93%E8%AE%BA"><span class="toc-number">5.3.</span> <span class="toc-text">4.6结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7%E5%90%88%E7%90%86%E5%8F%82%E6%95%B0%E4%B8%BA%E4%BD%95%E8%83%BD%E6%AD%A3%E5%B8%B8%E5%81%9C%E6%AD%A2"><span class="toc-number">5.4.</span> <span class="toc-text">4.7合理参数为何能正常停止</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8%E7%BB%93%E8%AE%BA"><span class="toc-number">5.5.</span> <span class="toc-text">4.8结论</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/02/09/%E9%85%8D%E7%BD%AE-%E4%BC%98%E5%8C%96%E5%80%92%E8%AE%A1%E6%97%B6%E6%8C%82%E4%BB%B6/" title="配置&amp;优化倒计时挂件"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/cover6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="配置&amp;优化倒计时挂件"/></a><div class="content"><a class="title" href="/2026/02/09/%E9%85%8D%E7%BD%AE-%E4%BC%98%E5%8C%96%E5%80%92%E8%AE%A1%E6%97%B6%E6%8C%82%E4%BB%B6/" title="配置&amp;优化倒计时挂件">配置&amp;优化倒计时挂件</a><time datetime="2026-02-08T16:56:47.944Z" title="Created 2026-02-09 00:56:47">2026-02-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/02/08/%E4%B8%BAtwikoo%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE%E4%BA%8C%E7%BA%A7%E5%9F%9F%E5%90%8D/" title="为twikoo评论系统设置二级域名"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="为twikoo评论系统设置二级域名"/></a><div class="content"><a class="title" href="/2026/02/08/%E4%B8%BAtwikoo%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE%E4%BA%8C%E7%BA%A7%E5%9F%9F%E5%90%8D/" title="为twikoo评论系统设置二级域名">为twikoo评论系统设置二级域名</a><time datetime="2026-02-08T04:37:45.071Z" title="Created 2026-02-08 12:37:45">2026-02-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/02/07/%E7%94%A8Google-Fonts%E4%B8%BAHexo%E5%8D%9A%E5%AE%A2%E6%9B%BF%E6%8D%A2%E5%AD%97%E4%BD%93/" title="用Google Fonts为Hexo博客替换字体"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/cover2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用Google Fonts为Hexo博客替换字体"/></a><div class="content"><a class="title" href="/2026/02/07/%E7%94%A8Google-Fonts%E4%B8%BAHexo%E5%8D%9A%E5%AE%A2%E6%9B%BF%E6%8D%A2%E5%AD%97%E4%BD%93/" title="用Google Fonts为Hexo博客替换字体">用Google Fonts为Hexo博客替换字体</a><time datetime="2026-02-07T06:08:40.793Z" title="Created 2026-02-07 14:08:40">2026-02-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/02/02/%E5%9C%A8flaticon%E5%B8%AE%E4%BD%A0%E7%9A%84%E7%BD%91%E7%AB%99%E6%89%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%9C%8B%E7%9A%84%E7%9F%A2%E9%87%8F%E5%9B%BE%E6%A0%87/" title="在Flaticon帮你的网站找到一个好看的矢量图标"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在Flaticon帮你的网站找到一个好看的矢量图标"/></a><div class="content"><a class="title" href="/2026/02/02/%E5%9C%A8flaticon%E5%B8%AE%E4%BD%A0%E7%9A%84%E7%BD%91%E7%AB%99%E6%89%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%9C%8B%E7%9A%84%E7%9F%A2%E9%87%8F%E5%9B%BE%E6%A0%87/" title="在Flaticon帮你的网站找到一个好看的矢量图标">在Flaticon帮你的网站找到一个好看的矢量图标</a><time datetime="2026-02-02T14:00:24.978Z" title="Created 2026-02-02 22:00:24">2026-02-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/02/02/Adobe-Express%E5%B8%AE%E5%8A%A9%E4%BD%A0%E5%88%9B%E5%BB%BA%E8%83%8C%E6%99%AF%E9%80%8F%E6%98%8E%E5%9B%BE%E7%89%87/" title="Adobe Express帮助你创建背景透明图片"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/cover6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Adobe Express帮助你创建背景透明图片"/></a><div class="content"><a class="title" href="/2026/02/02/Adobe-Express%E5%B8%AE%E5%8A%A9%E4%BD%A0%E5%88%9B%E5%BB%BA%E8%83%8C%E6%99%AF%E9%80%8F%E6%98%8E%E5%9B%BE%E7%89%87/" title="Adobe Express帮助你创建背景透明图片">Adobe Express帮助你创建背景透明图片</a><time datetime="2026-02-02T12:41:23.146Z" title="Created 2026-02-02 20:41:23">2026-02-02</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-上班摸鱼中.svg" alt="距离月入25k也就还差一个大佬带我~" title="距离月入25k也就还差一个大佬带我~"/><div id="runtimeTextTip"></div></div><div class="footer_custom_text">祝看到这里的你每天开心~早日暴富</div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2026 By <a class="footer-bar-link" href="/" title="agsd" target="_blank">agsd</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  if (true) { 
    window.typed = new Typed("#footer-type-tips", {
      strings: ["Welcome to my blog, here is agsd's world."],
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50
    })
  } else {
    document.getElementById("footer-type-tips").innerHTML = 'Welcome to my blog, here is agsd's world.'
  }
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a><a class="footer-bar-link cc" href="/copyright" title="CC License"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">Articles</div><div class="length-num">6</div></a><a href="/tags/" title="tag"><div class="headline">Tags</div><div class="length-num">4</div></a><a href="/categories/" title="category"><div class="headline">Categories</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">Function</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="Display Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>Display Mode</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/agsd-agsd" title="Github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/icons/GitHub_Logo.png" alt="Github"/><span class="back-menu-item-text">Github</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">快乐老家</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.pixiv.net/" title="Pixiv"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/icons/pixiv.png" alt="Pixiv"/><span class="back-menu-item-text">Pixiv</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> Album</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> MyInfo</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> Stroll</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BrokerHub/" style="font-size: 0.88rem; color: rgb(55, 184, 66); font-weight: 500; color: var(--anzhiyu-lighttext)">BrokerHub<sup>1</sup></a><a href="/tags/Tools/" style="font-size: 0.88rem; color: rgb(152, 81, 60);">Tools<sup>2</sup></a><a href="/tags/hexo/" style="font-size: 0.88rem; color: rgb(165, 22, 2); font-weight: 500; color: var(--anzhiyu-lighttext)">hexo<sup>5</sup></a><a href="/tags/website/" style="font-size: 0.88rem; color: rgb(26, 28, 10);">website<sup>3</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="6909251788" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=6909251788&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("02/02/2026 00:37:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2026 By 安知鱼 V1.7.1",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 agsd 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("02/02/2026 00:37:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-下班啦.svg";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@4.0.0/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.agsd.top/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.agsd.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: '',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
      imageUploader: true,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    anzhiyu.addGlobalFn('pjax', destroyWaline, 'destroyWaline')
  }

  const loadWaline = async () => {
    if (initFn) initWaline(initFn)
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@3.8.0/dist/waline.css')
      if (false) await getCSS('https://cdn.cbd.int/@waline/client@3.8.0/dist/waline-meta.css')
      const { init } = await import('https://cdn.cbd.int/@waline/client@3.8.0/dist/waline.js')
      initFn = init || Waline.init
      initWaline(initFn)
      window.walineFn = initFn
    }
  }

  if ('Twikoo' === 'Waline' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="/source/js/footer-animal.js" defer></script><script src="/js/count.js"></script><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="true" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>